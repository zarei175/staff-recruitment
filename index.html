<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فراخوان جذب همکار - واحد امور مالی</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Vazir -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .input-field {
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="bg-white rounded-lg card-shadow p-6 mx-auto max-w-4xl">
                <i class="fas fa-building text-4xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    فراخوان جذب همکار در واحد امور مالی
                </h1>
                <h2 class="text-xl text-gray-600">
                    اداره آموزش و پرورش بندر امام خمینی
                </h2>
                <div class="mt-4 w-24 h-1 bg-gradient-to-r from-blue-500 to-purple-600 mx-auto rounded"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-2xl mx-auto">
            
            <!-- Step 1: Personnel Number Input -->
            <div id="step1" class="bg-white rounded-lg card-shadow p-8 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-user-circle text-blue-600 ml-3"></i>
                    ورود شماره پرسنلی
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="personnelNumber" class="block text-sm font-medium text-gray-700 mb-2">
                            شماره پرسنلی خود را وارد کنید:
                        </label>
                        <input 
                            type="text" 
                            id="personnelNumber" 
                            class="w-full p-4 input-field rounded-lg text-center text-lg"
                            placeholder="مثال: 12345"
                            maxlength="10"
                        >
                    </div>
                    
                    <button 
                        id="searchBtn" 
                        class="w-full btn-primary text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center"
                    >
                        <i class="fas fa-search ml-2"></i>
                        جستجو
                    </button>
                </div>
                
                <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <i class="fas fa-exclamation-triangle ml-2"></i>
                    <span id="errorText"></span>
                </div>
            </div>

            <!-- Step 2: User Information Display -->
            <div id="step2" class="hidden bg-white rounded-lg card-shadow p-8 mb-6 fade-in">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-user-check text-green-600 ml-3"></i>
                    تأیید اطلاعات
                </h3>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl ml-3"></i>
                        <span class="text-green-800 font-semibold">اطلاعات شما یافت شد</span>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex">
                            <span class="font-semibold text-gray-700 w-24">نام:</span>
                            <span id="firstName" class="text-gray-800"></span>
                        </div>
                        <div class="flex">
                            <span class="font-semibold text-gray-700 w-24">نام خانوادگی:</span>
                            <span id="lastName" class="text-gray-800"></span>
                        </div>
                        <div class="flex">
                            <span class="font-semibold text-gray-700 w-24">شماره پرسنلی:</span>
                            <span id="displayPersonnelNumber" class="text-gray-800"></span>
                        </div>
                    </div>
                </div>
                
                <button 
                    id="continueBtn" 
                    class="w-full btn-primary text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center"
                >
                    <i class="fas fa-arrow-left ml-2"></i>
                    ادامه
                </button>
            </div>

            <!-- Step 3: Request Form -->
            <div id="step3" class="hidden bg-white rounded-lg card-shadow p-8 mb-6 fade-in">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-file-alt text-blue-600 ml-3"></i>
                    درخواست انتقال
                </h3>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <p class="text-gray-800 leading-relaxed" id="requestText">
                        اینجانب <span class="font-semibold text-blue-600" id="fullNameInText"></span> 
                        با شماره پرسنلی <span class="font-semibold text-blue-600" id="personnelInText"></span> 
                        علاقه‌مند به انتقال حوزه فعالیت خود از مدرسه به اداره آموزش و پرورش و اشتغال در سمت کارشناس امور مالی می‌باشم.
                    </p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button 
                        id="backBtn" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center transition-all duration-300"
                    >
                        <i class="fas fa-arrow-right ml-2"></i>
                        بازگشت
                    </button>
                    
                    <button 
                        id="submitBtn" 
                        class="flex-1 btn-primary text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center"
                    >
                        <i class="fas fa-check ml-2"></i>
                        تأیید و ثبت درخواست
                    </button>
                </div>
            </div>

            <!-- Step 4: Success Message -->
            <div id="step4" class="hidden bg-white rounded-lg card-shadow p-8 mb-6 fade-in">
                <div class="text-center">
                    <div class="pulse-animation">
                        <i class="fas fa-check-circle text-6xl text-green-600 mb-6"></i>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">
                        درخواست شما با موفقیت ثبت شد
                    </h3>
                    
                    <p class="text-gray-600 mb-6 leading-relaxed">
                        درخواست انتقال شما به واحد امور مالی ثبت گردید. 
                        <br>
                        نتیجه بررسی از طریق مراجع ذی‌صلاح اعلام خواهد شد.
                    </p>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <p class="text-green-800">
                            <i class="fas fa-info-circle ml-2"></i>
                            تاریخ ثبت: <span id="submitDate"></span>
                        </p>
                    </div>
                    
                    <button 
                        id="newRequestBtn" 
                        class="btn-primary text-white font-semibold py-3 px-8 rounded-lg flex items-center justify-center mx-auto"
                    >
                        <i class="fas fa-plus ml-2"></i>
                        درخواست جدید
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-12">
            <div class="bg-white bg-opacity-20 rounded-lg p-4 max-w-lg mx-auto">
                <p class="text-white text-sm">
                    <i class="fas fa-shield-alt ml-2"></i>
                    اداره آموزش و پرورش بندر امام خمینی
                </p>
                <p class="text-white text-xs mt-2">
                    سیستم مدیریت درخواست‌های انتقال
                </p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://authyuwcaouwdvyqaucc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1dGh5dXdjYW91d2R2eXFhdWNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNTAyMTksImV4cCI6MjA2NDgyNjIxOX0.pQ7AsnwmFKgmXIX0kuKNpaHJeWjcL3-rYgeby1dN_Zs';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;

        // DOM Elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        
        const personnelNumberInput = document.getElementById('personnelNumber');
        const searchBtn = document.getElementById('searchBtn');
        const continueBtn = document.getElementById('continueBtn');
        const backBtn = document.getElementById('backBtn');
        const submitBtn = document.getElementById('submitBtn');
        const newRequestBtn = document.getElementById('newRequestBtn');
        
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // Event Listeners
        searchBtn.addEventListener('click', searchPersonnel);
        continueBtn.addEventListener('click', showRequestForm);
        backBtn.addEventListener('click', goBackToStep2);
        submitBtn.addEventListener('click', submitRequest);
        newRequestBtn.addEventListener('click', resetForm);
        
        personnelNumberInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPersonnel();
            }
        });

        // Functions
        async function searchPersonnel() {
            const personnelNumber = personnelNumberInput.value.trim();
            
            if (!personnelNumber) {
                showError('لطفاً شماره پرسنلی خود را وارد کنید');
                return;
            }

            // Show loading state
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال جستجو...';
            searchBtn.disabled = true;
            hideError();

            try {
                // Search in Supabase
                const { data, error } = await supabase
                    .from('staff_info')
                    .select('*')
                    .eq('personnel_number', personnelNumber)
                    .single();

                if (error || !data) {
                    showError('شماره پرسنلی یافت نشد. لطفاً شماره صحیح را وارد کنید');
                    return;
                }

                // Store user data
                currentUser = data;
                
                // Display user information
                document.getElementById('firstName').textContent = data.first_name;
                document.getElementById('lastName').textContent = data.last_name;
                document.getElementById('displayPersonnelNumber').textContent = data.personnel_number;
                
                // Show step 2
                hideAllSteps();
                step2.classList.remove('hidden');
                
            } catch (err) {
                console.error('Error searching personnel:', err);
                showError('خطا در جستجو. لطفاً دوباره تلاش کنید');
            } finally {
                // Reset button state
                searchBtn.innerHTML = '<i class="fas fa-search ml-2"></i>جستجو';
                searchBtn.disabled = false;
            }
        }

        function showRequestForm() {
            if (!currentUser) return;
            
            // Fill the request text
            const fullName = `${currentUser.first_name} ${currentUser.last_name}`;
            document.getElementById('fullNameInText').textContent = fullName;
            document.getElementById('personnelInText').textContent = currentUser.personnel_number;
            
            // Show step 3
            hideAllSteps();
            step3.classList.remove('hidden');
        }

        function goBackToStep2() {
            hideAllSteps();
            step2.classList.remove('hidden');
        }

        async function submitRequest() {
            if (!currentUser) return;

            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال ثبت...';
            submitBtn.disabled = true;

            try {
                // Save request to Supabase
                const { error } = await supabase
                    .from('transfer_requests')
                    .insert([
                        {
                            personnel_number: currentUser.personnel_number,
                            full_name: `${currentUser.first_name} ${currentUser.last_name}`,
                            first_name: currentUser.first_name,
                            last_name: currentUser.last_name,
                            request_date: new Date().toISOString(),
                            status: 'pending'
                        }
                    ]);

                if (error) {
                    console.error('Error submitting request:', error);
                    showError('خطا در ثبت درخواست. لطفاً دوباره تلاش کنید');
                    return;
                }

                // Show success message
                const now = new Date();
                const dateStr = now.toLocaleDateString('fa-IR');
                const timeStr = now.toLocaleTimeString('fa-IR');
                document.getElementById('submitDate').textContent = `${dateStr} - ${timeStr}`;
                
                hideAllSteps();
                step4.classList.remove('hidden');
                
            } catch (err) {
                console.error('Error submitting request:', err);
                showError('خطا در ثبت درخواست. لطفاً دوباره تلاش کنید');
            } finally {
                // Reset button state
                submitBtn.innerHTML = '<i class="fas fa-check ml-2"></i>تأیید و ثبت درخواست';
                submitBtn.disabled = false;
            }
        }

        function resetForm() {
            currentUser = null;
            personnelNumberInput.value = '';
            hideError();
            hideAllSteps();
            step1.classList.remove('hidden');
        }

        function hideAllSteps() {
            step1.classList.add('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');
            step4.classList.add('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // Initialize
        hideError();
    </script>
</body>
